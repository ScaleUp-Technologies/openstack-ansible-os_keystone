# {{ ansible_managed }}

# vim:set ft=upstart ts=2 et:

description "{{ item }} under uWSGI"
author "Kevin Carter <kevin.carter@rackspace.com>"

start on runlevel [2345]
stop on runlevel [016]

respawn
respawn limit 10 5

kill timeout 120

# Set the RUNBIN environment variable
env RUNBIN="{{ keystone_bin }}/uwsgi"

# Change directory to service users home
chdir "{{ keystone_system_user_home }}"

# Pre start actions
pre-start script
  mkdir -p "/var/run/{{ item }}"
  chown {{ keystone_system_user_name }}:{{ keystone_system_group_name }} "/var/run/{{ item }}"

  mkdir -p "/var/lock/{{ item }}"
  chown {{ keystone_system_user_name }}:{{ keystone_system_group_name }} "/var/lock/{{ item }}"

  . {{ keystone_bin }}/activate

end script

# Post stop actions
# Sleep configured number of seconds between restarts
post-stop script
  rm "/var/run/{{ item }}/{{ item }}.pid"
  sleep 2
end script

# Run the start up job
exec start-stop-daemon --start \
                       --make-pidfile \
                       --pidfile /var/run/{{ item }}/{{ item }}.pid \
                       --exec "{{ program_override | default('$RUNBIN') }}" \
                       -- --ini "/etc/uwsgi/{{ item }}.ini" \
                       --logto /var/log/keystone/{{ item }}.log \
                       -- {{ program_config_options | default('') }}
